name: Build and Release Debian Package

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Target commit SHA to build (full SHA recommended).'
        required: true
        type: string

jobs:

  build-and-release:
    name: Build and Release Debian Package
    # Run on arm64 hosted runner to avoid QEMU emulation slowness.
    runs-on: ubuntu-22.04-arm
    strategy:
      matrix:
        image:
          - arm64v8/ubuntu
    permissions:
      contents: write
    steps:

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.commit_sha || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # The package is still built inside Ubuntu 20.04 container for glibc compatibility.
      - name: Cache Docker layers
        uses: docker/build-push-action@v3
        with:
          context: .github/workflows/
          tags: ${{ matrix.image }}:build
          platforms: linux/arm64
          build-args: IMAGE=${{ matrix.image }}:20.04
          cache-from: type=gha,scope=${{ matrix.image }}
          cache-to: type=gha,scope=${{ matrix.image }},mode=max
          load: true

      - name: Build
        run: |
          docker run --rm -i -v $(pwd):/work -w /work ${{ matrix.image }}:build bash -c 'debuild -us -uc -b && cp -a ../*.deb ./'

      - name: Get version
        id: get_version
        run: |
          echo "version=$(docker run --rm -i -v $(pwd):/work -w /work ${{ matrix.image }}:build bash -c 'dpkg-parsechangelog --show-field Version')" >> $GITHUB_OUTPUT

      - name: Get commit metadata
        id: get_commit_hash
        run: |
          echo "date=$(git show -s --format=%cd --date=format:%Y%m%d HEAD)" >> $GITHUB_OUTPUT
          echo "full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.get_version.outputs.version }}-${{ steps.get_commit_hash.outputs.date }}-${{ steps.get_commit_hash.outputs.short }}
          tag_name: v${{ steps.get_version.outputs.version }}-${{ steps.get_commit_hash.outputs.date }}-${{ steps.get_commit_hash.outputs.short }}
          target_commitish: ${{ steps.get_commit_hash.outputs.full }}
          generate_release_notes: true
          files: |
            ./*.deb
